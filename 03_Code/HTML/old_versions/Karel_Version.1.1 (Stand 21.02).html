<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Karel the Robot</title>
<script type="text/javascript">
    
// Mittels der Funktion init() wird Karels Welt erschaffen
function init() {
   	var canvas = document.getElementById("ausgabe");
   	
	// prüft, ob Browser mit Canvas umgehen kann
	if (canvas.getContext) {
       	var c = canvas.getContext("2d");
		//  "j" bezeichnet die x-Richtung und "i" die y-Richtung
		for(i=2; i<15; i++) {
			for(j=0; j<14; j++) {
				
				/*
				* Spaltennummerierung
				* Ursprung links oben
				if (i<2 && j>0) {
				*/
				
				// Ursprung links unten
				if (i>13 && j>0) {
					c.fillStyle = "#000";
					c.font = "px Arial";
					c.textBaseline = 'bottom';
					c.fillText (j,window.innerWidth/3 + j/15*2/3*window.innerWidth,i/15*window.innerHeight+1/30*window.innerHeight);
				
				} 	else if (j<1 && i<14) {
						// Zeilennummerierung
						c.fillStyle = "#000";
						c.font = "Arial";
						c.textBaseline = 'bottom';
						c.fillText (14-i,window.innerWidth/3 - 1/30*2/3*window.innerWidth,i/15*window.innerHeight);
					
					}	else {
						c.fillStyle = "#000";
						c.lineWidth = 1;
						c.beginPath();
						// interative Bewegung in x-Richtung um 1/15 von den restlichen 2/3 des Bildschiirm
						// waagrechte Striche der Koordinatenkreuze
						c.moveTo(window.innerWidth/3 + j/15*2/3*window.innerWidth, i/15*window.innerHeight);
						c.lineTo(window.innerWidth/3 + j/15*2/3*window.innerWidth + 5, i/15*window.innerHeight);
						//senkrechte Striche der Koordinatenkreuze
						c.moveTo(window.innerWidth/3 + j/15*2/3*window.innerWidth +2, i/15*window.innerHeight -2);
						c.lineTo(window.innerWidth/3 + j/15*2/3*window.innerWidth +2, i/15*window.innerHeight +2);
						c.stroke();
					}
			}
		}
		// Rahmen zur Spielfeldbegrenzung zeichnen
		
		c.beginPath();
		c.fillStyle = "#000";
		c.lineWidth = 1;
		c.moveTo(window.innerWidth/3, 1/15*window.innerHeight);
		c.lineTo(window.innerWidth/3, 14/15*window.innerHeight);
		c.lineTo(window.innerWidth/3 + 14/15*2/3*window.innerWidth, 14/15*window.innerHeight);
		c.lineTo(window.innerWidth/3 + 14/15*2/3*window.innerWidth, 1/15*window.innerHeight);
		c.lineTo(window.innerWidth/3, 1/15*window.innerHeight);
		c.stroke();
		
	
		c.fillStyle = "#00f";
		//c.font = 'bold italic 30px Arial';
		c.textBaseline = 'bottom';
		c.fillText('HTML5 is mächtig!', 100, 100);
	
				
	// falls der Browser kein Canvas versteht, erscheint folgende Fehlermeldung
	} else alert("Canvas required!")

}


/*
* Initialisation of the position arrays for karel, beeper and wall 
* Falls eine Postition im Array "true" ist, ist diese belegt, ansonsnten leer.	
*/

// array for beeper position
var beeper = new Array(15);
for(j=0; j<15; j++) 
	beeper[j] = new Array(14);

for(j=0; j<15; j++) {
	for(i=0; i<14; i++) {
		beeper[j][i]= false;
	}
}

// variable, wich shows the amount of Beepers Karel got with him
var countBeeper = 0;


// array for karel's position		
var karel = new Array(15);
for(j=0; j<15; j++) 
	karel[j] = new Array(14);

for(j=0; j<15; j++) {
	for(i=0; i<14; i++) {
		karel[j][i]= false;
	}
}

// array for outer wall		
var wall = new Array(15);
for(j=0; j<15; j++) 
	wall[j] = new Array(14)

for(j=0; j<15; j++) {
	for(i=0; i<14; i++) {
		if (j==0 || j==14 || i==0 || i==13) {
			wall[j][i] = true;
		} else wall[j][i] = false;
	}
}


// basic functions

function move() {
	//  Überprüfen, wo Karel steht
	for(j=0; j<15; j++) {
		for(i=0; i<14; i++) {
			if (karel[j][i] && facing.east && wall[j+1][i]==false) {
				// vorherige Position wird auf false gesetzt, damit an dieser Stelle kein Karel mehr erscheint
				karel[j][i] = false;
				j+=1;
				drawKarel(j,i);
			} else if (karel[j][i] && facing.west && wall[j-1][i]==false) {
				// vorherige Position wird auf false gesetzt, damit an dieser Stelle kein Karel mehr erscheint
				karel[j][i] = false;
				j-=1;
				drawKarel(j,i);
			} else if (karel[j][i] && facing.north && wall[j][i+1]==false) {
				// vorherige Position wird auf false gesetzt, damit an dieser Stelle kein Karel mehr erscheint
				karel[j][i] = false;
				i+=1;
				drawKarel(j,i);
			} else if (karel[j][i] && facing.south && wall[j][i-1]==false) {
				// vorherige Position wird auf false gesetzt, damit an dieser Stelle kein Karel mehr erscheint
				karel[j][i] = false;
				i-=1;
				drawKarel(j,i);
			}	
		}	
	}				
}

function turnLeft() {
	if (facing.north) {
		facing.north = false;
		facing.west  = true;
	} else if (facing.south) {
		facing.south = false;
		facing.east  = true;
	} else if (facing.west) {
		facing.west  = false;
		facing.south = true;
	} else {
		facing.east  = false;
		facing.north = true;
	}
	// check karel's position
	for(j=0; j<15; j++) {
		for(i=0; i<14; i++) {
			if (karel[j][i])
			drawKarel(j,i);
		}
	}
}


function pickBeeper() {
	for(j=0; j<15; j++) {
		for(i=0; i<14; i++) {
			if (karel[j][i] && beeper[j][i]) {
				
			}
		}
	}
}


// basic conditions 
// karel's direction of view

facing = {
	"north" : false,
	"south" : false,
	"west"  : false,
	"east"  : true
}

// functions, wich return karel's direction of view

function facingNorth() {
	return facing.north;
}
function facingSouth() {
	return facing.south;
}
function facingWest() {
	return facing.west;
}
function facingEast() {
	return facing.east;
}

// negated functions, wich return karel's non-direction of view

function notFacingNorth() {
	return !facing.north;
}
function notFacingSouth() {
	return !facing.south;
}
function notFacingWest() {
	return !facing.west;
}
function notFacingEast() {
	return !facing.east;
}


function drawKarel(posX,posY) {
	var canvas = document.getElementById("ausgabe");
	var c = canvas.getContext("2d");
	c.clearRect(0,0,canvas.width,canvas.height);
	init();
	karel[posX][posY] = true;
	beeper[5][5] = true;
	
	// check karel's position and draw karel
	for(j=0; j<15; j++) {
		for(i=0; i<14; i++) {
			if (karel[j][i]) {
				var imgKarel = new Image();
				if (facing.north) {
				imgKarel.src ="karelNorth.png";
				} else if (facing.south) {
				imgKarel.src ="karelSouth.png";
				} else if (facing.west) {
				imgKarel.src ="karelWest.png";
				} else {
				imgKarel.src ="karelEast.png";
				}
				c.drawImage(imgKarel,window.innerWidth/3 + j/15*2/3*window.innerWidth-1/45*2/3*window.innerWidth,
				(14-i)/15*window.innerHeight-1/45*window.innerHeight, 1/15*window.innerHeight, 1/15*window.innerHeight);	
			}
			
			// check beeper's position and draw beeper
			if (beeper[j][i]) {
				c.fillStyle = "#bbb" //grey
				c.lineWidth = 2;
				c.beginPath();
				c.moveTo(window.innerWidth/3 + j/15*2/3*window.innerWidth+2, i/15*window.innerHeight + 1/40*window.innerHeight);
				c.lineTo(window.innerWidth/3 + j/15*2/3*window.innerWidth+2 - 1/50*2/3*window.innerWidth, i/15*window.innerHeight);
				c.lineTo(window.innerWidth/3 + j/15*2/3*window.innerWidth+2, i/15*window.innerHeight - 1/40*window.innerHeight);
				c.lineTo(window.innerWidth/3 + j/15*2/3*window.innerWidth+2 + 1/50*2/3*window.innerWidth, i/15*window.innerHeight);
				c.closePath();
				c.fill();
				c.stroke();
			}
		}
	}
}	

// Alle Bilder werden vor Aufruf in den Speicher geladen
// Quelle: http://www.javascriptkit.com/javatutors/preloadimagesplus.shtml	
function preloadimages(arr){
    var newimages=[], loadedimages=0
    var arr=(typeof arr!="object")? [arr] : arr

    function imageloadpost(){
    	loadedimages++
		// shows how many pictures are loaded
      	if (loadedimages==arr.length){
	 	// alert(arr.length);
	  	}
    }

    for (var i=0; i<arr.length; i++){
        newimages[i]=new Image()
        newimages[i].src=arr[i]
        newimages[i].onload=function(){
            imageloadpost()
        }
        newimages[i].onerror=function(){
        imageloadpost()
        }
    }
}

//sample run
preloadimages(['karelEast.png','karelWest.png','karelSouth.png','karelNorth.png']);

</script>
</head>

<body onload = drawKarel(1,1)>
<div>
<canvas id="ausgabe" width="1270" height="658"></canvas>
</div>

<script type="text/javascript" charset="utf-8">
init();	
</script>

<input type="button" name="Go" value="walkToWall" id="Go" onclick="setInterval(function(){move()},200)">
<input type="button" name="Go" value="move!" id="Go" onclick="move()">
<input type="button" name="Go" value="turnLeft" id="Go" onclick="turnLeft()">


</body>
</html>
